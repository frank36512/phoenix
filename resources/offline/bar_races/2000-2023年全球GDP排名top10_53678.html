<!DOCTYPE html>
<html style="height: 100%">
<head>
    <meta charset="utf-8">
    <title>2000-2023年全球GDP排名top10 - 动态排序图</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        body { margin: 0; background-color: #f0f2f5; font-family: 'Microsoft YaHei', sans-serif; }
        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }
        #container { height: 100vh; width: 100vw; position: relative; z-index: 1; }
    </style>
</head>
<body style="height: 100%; margin: 0">
    <div id="bg-layer"></div>
    <div id="container"></div>

    <script type="text/javascript">
        var dom = document.getElementById('container');
        var myChart = echarts.init(dom);
        var rawData = {"title": "2000-2023年全球主要经济体GDP排名演变", "subtitle": "单位：亿美元", "categories": ["美国", "中国", "日本", "德国", "英国", "印度", "法国", "意大利", "巴西", "加拿大"], "timeline": ["2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022", "2023"], "data": [[10280, 1211, 4968, 1948, 1665, 468, 1366, 1147, 655, 742], [10620, 1339, 4375, 1945, 1644, 485, 1378, 1171, 559, 736], [10980, 1470, 4182, 2077, 1786, 515, 1498, 1276, 510, 758], [11510, 1660, 4519, 2501, 2056, 607, 1843, 1577, 558, 895], [12270, 1955, 4893, 2814, 2416, 709, 2120, 1803, 669, 1025], [13090, 2285, 4831, 2855, 2544, 820, 2198, 1857, 892, 1170], [13850, 2752, 4601, 3004, 2717, 940, 2327, 1949, 1107, 1319], [14470, 3550, 4576, 3444, 3106, 1216, 2666, 2213, 1396, 1468], [14710, 4594, 5106, 3770, 2970, 1198, 2937, 2408, 1695, 1552], [14440, 5101, 5289, 3426, 2433, 1341, 2700, 2199, 1669, 1376], [14990, 6087, 5759, 3423, 2491, 1675, 2647, 2136, 2208, 1617], [15540, 7551, 6233, 3761, 2674, 1823, 2865, 2294, 2616, 1793], [16190, 8532, 6272, 3546, 2719, 1827, 2686, 2088, 2465, 1828], [16780, 9570, 5209, 3753, 2803, 1856, 2811, 2141, 2472, 1846], [17520, 10475, 4896, 3898, 3087, 2039, 2856, 2162, 2456, 1805], [18230, 11061, 4444, 3383, 2956, 2103, 2439, 1836, 1802, 1556], [18740, 11233, 5003, 3496, 2704, 2294, 2472, 1877, 1798, 1527], [19540, 12310, 4930, 3690, 2683, 2651, 2594, 1961, 2063, 1649], [20610, 13894, 5040, 3976, 2904, 2702, 2792, 2092, 1916, 1721], [21430, 14279, 5123, 3888, 2878, 2831, 2728, 2011, 1873, 1742], [20950, 14687, 5040, 3889, 2756, 2667, 2647, 1897, 1448, 1645], [23310, 17734, 5034, 4262, 3141, 3150, 2957, 2114, 1608, 2001], [25460, 17963, 4232, 4082, 3089, 3385, 2779, 2049, 1920, 2139], [27360, 17700, 4210, 4450, 3340, 3730, 3030, 2250, 2130, 2120]]};
        
        // Configuration Object
        var config = {
            colors: ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc'],
            fontFamily: 'Microsoft YaHei',
            fontSize: 24,
            fontColor: '#333',
            backgroundColor: '#f0f2f5', // Deprecated in favor of backgroundStyle for complex backgrounds
            backgroundStyle: '#f0f2f5', // Can be color or CSS gradient
            backgroundImage: "",
            bgOpacity: 1.0,
            showLabel: true,
            labelFont: 'monospace',
            updateFrequency: 2000,
            dataSource: "",
            // New Bar Styles
            barColorMode: 'category', // 'category', 'single', 'gradient'
            barSingleColor: '#5470c6',
            barGradient: null, // ECharts gradient object
            barBorderRadius: 5,
            barOpacity: 1.0
        };

        // Apply global styles
        function applyGlobalStyles() {
            // Prefer backgroundStyle, fallback to backgroundColor
            var bgStyle = config.backgroundStyle || config.backgroundColor;
            
            // Predefined Gradients and Colors
            var gradients = {
                'rainbow': 'linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3)',
                'cool': 'linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)',
                'warm': 'linear-gradient(120deg, #f6d365 0%, #fda085 100%)',
                'neon': 'linear-gradient(to right, #00f260, #0575e6)',
                'sunset': 'linear-gradient(to right, #ff7e5f, #feb47b)',
                'ocean': 'linear-gradient(to right, #2E3192, #1BFFFF)',
                'dark': '#1a1a1a',
                'light': '#f0f2f5'
            };

            if (gradients[bgStyle]) {
                bgStyle = gradients[bgStyle];
            }
            
            // Check if it's a gradient (contains "gradient") or simple color
            if (bgStyle && bgStyle.indexOf('gradient') !== -1) {
                 document.body.style.background = bgStyle;
            } else {
                 document.body.style.background = "";
                 document.body.style.backgroundColor = bgStyle;
            }

            var bgLayer = document.getElementById('bg-layer');
            if (config.backgroundImage) {
                bgLayer.style.backgroundImage = config.backgroundImage;
                bgLayer.style.opacity = config.bgOpacity;
            } else {
                bgLayer.style.backgroundImage = "none";
            }
            document.body.style.fontFamily = config.fontFamily;
        }
        applyGlobalStyles();
        
        var currentYearIndex = 0;
        var timer = null;

        // 1. Static/Structural Option (Grids, Axes)
        function getAxisOption() {
            var itemCount = rawData.categories.length;
            return {
                grid: {
                    left: 150, // Increase left margin to accommodate rank numbers
                    right: 150, // Increase right margin for labels and values
                    top: 80,
                    bottom: 30,
                    containLabel: false
                },
                xAxis: {
                    type: 'value',
                    max: 'dataMax',
                    axisLabel: {
                        formatter: function (n) {
                            return Math.round(n);
                        },
                        fontFamily: config.fontFamily
                    }
                },
                yAxis: {
                    type: 'category',
                    inverse: true,
                    max: itemCount - 1,
                    axisLabel: {
                        show: false // Hide default labels
                    },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    animationDuration: 300,
                    animationDurationUpdate: 300
                }
            };
        }

        // Calculate and return graphic elements for rank numbers
        function getRankGraphic() {
            var itemCount = rawData.categories.length;
            var elements = [];
            
            // Try to use convertToPixel for perfect alignment
            var useExact = false;
            try {
                // Check if coordinate system is ready by testing index 0
                // We use {gridIndex: 0} or {yAxisIndex: 0}
                var testPos = myChart.convertToPixel({yAxisIndex: 0}, 0);
                if (testPos) {
                    useExact = true;
                }
            } catch (e) {
                // Ignore
            }

            if (useExact) {
                for (var i = 0; i < itemCount; i++) {
                    var position = myChart.convertToPixel({yAxisIndex: 0}, i);
                    elements.push({
                        type: 'text',
                        left: 100, // Fixed horizontal position
                        top: position[1], // Exact Y coordinate from axis
                        style: {
                            text: (i + 1).toString(),
                            textAlign: 'center',
                            textVerticalAlign: 'middle',
                            fontSize: 16,
                            fontWeight: 'bold',
                            fontFamily: config.fontFamily,
                            fill: config.fontColor
                        },
                        z: 100,
                        silent: true
                    });
                }
            } else {
                // Fallback to manual calculation (approximate)
                var top = 80;
                var bottom = 30;
                var height = myChart.getHeight() - top - bottom;
                var step = height / itemCount;
                
                for (var i = 0; i < itemCount; i++) {
                    elements.push({
                        type: 'text',
                        left: 100,
                        top: top + i * step + step / 2,
                        style: {
                            text: (i + 1).toString(),
                            textAlign: 'center',
                            textVerticalAlign: 'middle',
                            fontSize: 16,
                            fontWeight: 'bold',
                            fontFamily: config.fontFamily,
                            fill: config.fontColor
                        },
                        z: 100,
                        silent: true
                    });
                }
            }
            return elements;
        }

        // 2. Dynamic Option (Series, Title, Graphic)
        function getSeriesOption(index) {
            var year = rawData.timeline[index];
            var dataValues = rawData.data[index];
            var itemCount = rawData.categories.length;
            
            var seriesData = [];
            for (var i = 0; i < itemCount; i++) {
                var itemColor;
                if (config.barColorMode === 'single') {
                    itemColor = config.barSingleColor;
                } else if (config.barColorMode === 'gradient' && config.barGradient) {
                    itemColor = config.barGradient;
                } else {
                    // Category/Default
                    itemColor = config.colors[i % config.colors.length];
                }

                seriesData.push({
                    value: dataValues[i],
                    name: rawData.categories[i],
                    itemStyle: {
                        color: itemColor
                    }
                });
            }

            return {
                title: {
                    text: rawData.title,
                    subtext: rawData.subtitle + ' (' + year + ')',
                    left: 'center',
                    top: 20,
                    textStyle: { 
                        fontSize: config.fontSize, 
                        fontWeight: 'bold',
                        fontFamily: config.fontFamily
                    }
                },
                series: [{
                    // Dynamic Race Series
                    realtimeSort: true,
                    name: 'Value',
                    type: 'bar',
                    data: seriesData,
                    encode: {
                        x: 'value',
                        y: 'name'
                    },
                    label: {
                        show: config.showLabel,
                        position: 'right',
                        valueAnimation: true,
                        fontFamily: config.labelFont,
                        color: config.fontColor,
                        formatter: function(params) {
                             return params.name + '  ' + Math.round(params.value);
                        }
                    },
                    itemStyle: {
                        borderRadius: [0, config.barBorderRadius, config.barBorderRadius, 0],
                        opacity: config.barOpacity
                    }
                }],
                animationDuration: 0,
                animationDurationUpdate: config.updateFrequency,
                animationEasing: 'linear',
                animationEasingUpdate: 'linear',
                graphic: {
                    elements: [{
                        type: 'text',
                        right: 60,
                        bottom: 60,
                        style: {
                            text: year,
                            font: 'bold 80px ' + config.labelFont,
                            fill: 'rgba(100, 100, 100, 0.25)'
                        },
                        z: 100
                    }].concat(config.dataSource ? [{
                        type: 'text',
                        right: 10,
                        bottom: 10,
                        style: {
                            text: '数据来源: ' + config.dataSource,
                            font: '14px ' + config.fontFamily,
                            fill: config.fontColor
                        },
                        z: 100
                    }] : []).concat(getRankGraphic()) // Add rank numbers
                }
            };
        }

        // Function to update config from outside
        function updateConfig(newConfig) {
            Object.assign(config, newConfig);
            
            // Calculate updateFrequency if duration is provided
            if (newConfig.duration && rawData.timeline && rawData.timeline.length > 1) {
                config.updateFrequency = newConfig.duration / (rawData.timeline.length - 1);
                
                // Restart animation to apply new speed
                if (timer) clearInterval(timer);
                runAnimation();
            }
            
            applyGlobalStyles();
            
            // Update structural config (Fonts, Colors)
            myChart.setOption(getAxisOption());
            
            // Update data/series config
            myChart.setOption(getSeriesOption(currentYearIndex));
        }

        // Initial render
        myChart.setOption(getAxisOption());
        myChart.setOption(getSeriesOption(0));

        function runAnimation() {
            if (timer) clearInterval(timer);
            currentYearIndex = 0;
            myChart.setOption(getSeriesOption(0));
            
            timer = setInterval(function () {
                currentYearIndex++;
                if (currentYearIndex >= rawData.timeline.length) {
                    clearInterval(timer);
                    return;
                }
                myChart.setOption(getSeriesOption(currentYearIndex));
            }, config.updateFrequency);
        }

        setTimeout(runAnimation, 1000);

        window.addEventListener('resize', function() {
            myChart.resize();
            // Force update of graphic elements to realign with new coordinates
            myChart.setOption(getSeriesOption(currentYearIndex));
        });

        // Video Export Support: Deterministic Rendering
        window.prepareTimeline = function() {
            if (timer) clearInterval(timer);
            currentYearIndex = 0;
            // Reset to start
            myChart.setOption(getSeriesOption(0));
            
            // Calculate total duration
            // We have N points. There are N-1 intervals of duration config.updateFrequency.
            var totalDuration = (rawData.timeline.length - 1) * config.updateFrequency;
            // Add 2 seconds buffer at the end
            totalDuration += 2000; 
            
            return Promise.resolve({
                totalDuration: totalDuration
            });
        };

        window.startSlowMotionAnimation = function(speedRatio) {
            if (timer) clearInterval(timer);
            
            // Slow down
            var originalFreq = config.updateFrequency;
            var newFreq = originalFreq / speedRatio;
            
            // Update config locally
            config.updateFrequency = newFreq;
            
            // Important: Update ECharts animation duration to match new frequency
            // We need to override the default options
            myChart.setOption({
                animationDuration: 0, 
                animationDurationUpdate: newFreq,
                animationEasing: 'cubicInOut', // Smoother easing
                animationEasingUpdate: 'cubicInOut' // Smoother easing
            });
            
            currentYearIndex = 0;
            myChart.setOption(getSeriesOption(0));
            
            window.animationFinished = false;
            
            // Start loop
            timer = setInterval(function () {
                currentYearIndex++;
                if (currentYearIndex >= rawData.timeline.length) {
                    clearInterval(timer);
                    window.animationFinished = true;
                    return;
                }
                myChart.setOption(getSeriesOption(currentYearIndex));
            }, newFreq);
            
            return {
                totalDuration: (rawData.timeline.length - 1) * newFreq + 2000 / speedRatio
            };
        };

        window.seekTo = function(time_ms) {
             var freq = config.updateFrequency;
             var totalPoints = rawData.timeline.length;
             
             // Calculate index and ratio
             var index = Math.floor(time_ms / freq);
             var ratio = (time_ms % freq) / freq;
             
             if (index >= totalPoints - 1) {
                 index = totalPoints - 1;
                 ratio = 0; // Finished
             }
             
             // Interpolate Data
             var currentValues = rawData.data[index];
             var nextValues = rawData.data[Math.min(index + 1, totalPoints - 1)];
             
             var interpolatedSeriesData = [];
             for (var i = 0; i < rawData.categories.length; i++) {
                 var startVal = currentValues[i];
                 var endVal = nextValues[i];
                 var val = startVal + (endVal - startVal) * ratio;
                 
                 // Color logic (same as getSeriesOption)
                 var itemColor;
                 if (config.barColorMode === 'single') {
                    itemColor = config.barSingleColor;
                 } else if (config.barColorMode === 'gradient' && config.barGradient) {
                    itemColor = config.barGradient;
                 } else {
                    itemColor = config.colors[i % config.colors.length];
                 }

                 interpolatedSeriesData.push({
                     value: val,
                     name: rawData.categories[i],
                     itemStyle: { color: itemColor }
                 });
             }
             
             var year = rawData.timeline[index]; 
             
             var option = {
                 series: [{
                     data: interpolatedSeriesData,
                     animation: false, // CRITICAL: No internal animation
                     realtimeSort: true,
                     label: {
                        show: config.showLabel,
                        position: 'right',
                        valueAnimation: false,
                        formatter: function(params) {
                             return params.name + '  ' + Math.round(params.value);
                        },
                        fontFamily: config.labelFont,
                        color: config.fontColor
                    },
                    itemStyle: {
                        borderRadius: [0, config.barBorderRadius, config.barBorderRadius, 0],
                        opacity: config.barOpacity
                    }
                 }],
                 animation: false,
                 graphic: {
                     elements: [{
                        type: 'text',
                        right: 60,
                        bottom: 60,
                        style: {
                            text: year,
                            font: 'bold 80px ' + config.labelFont,
                            fill: 'rgba(100, 100, 100, 0.25)'
                        }
                     }].concat(config.dataSource ? [{
                        type: 'text',
                        right: 10,
                        bottom: 10,
                        style: {
                            text: '数据来源: ' + config.dataSource,
                            font: '14px ' + config.fontFamily,
                            fill: config.fontColor
                        }
                     }] : []).concat(getRankGraphic()) 
                 }
             };
             
             myChart.setOption(option);
        };

    </script>
</body>
</html>